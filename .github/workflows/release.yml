name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show Xcode Version
        run: xcodebuild -version

      - name: Validate Signing Secrets
        shell: bash
        env:
          MACOS_CERTIFICATE_P12_BASE64: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
          NOTARY_KEY_ID: ${{ secrets.NOTARY_KEY_ID }}
          NOTARY_ISSUER_ID: ${{ secrets.NOTARY_ISSUER_ID }}
          NOTARY_API_KEY_P8: ${{ secrets.NOTARY_API_KEY_P8 }}
        run: |
          set -euo pipefail
          missing=()
          for key in \
            MACOS_CERTIFICATE_P12_BASE64 \
            MACOS_CERTIFICATE_PASSWORD \
            MACOS_KEYCHAIN_PASSWORD \
            MACOS_SIGNING_IDENTITY \
            NOTARY_KEY_ID \
            NOTARY_ISSUER_ID \
            NOTARY_API_KEY_P8; do
            if [[ -z "${!key:-}" ]]; then
              missing+=("${key}")
            fi
          done

          if [[ ${#missing[@]} -gt 0 ]]; then
            echo "::error::Missing required GitHub Actions secrets: ${missing[*]}"
            exit 1
          fi

      - name: Import Signing Certificate
        shell: bash
        env:
          MACOS_CERTIFICATE_P12_BASE64: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="${RUNNER_TEMP}/build-signing.keychain-db"
          CERT_PATH="${RUNNER_TEMP}/build-certificate.p12"

          echo "${MACOS_CERTIFICATE_P12_BASE64}" | base64 --decode > "${CERT_PATH}"

          security create-keychain -p "${MACOS_KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security set-keychain-settings -lut 21600 "${KEYCHAIN_PATH}"
          security unlock-keychain -p "${MACOS_KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security import "${CERT_PATH}" -P "${MACOS_CERTIFICATE_PASSWORD}" -A -t cert -f pkcs12 -k "${KEYCHAIN_PATH}"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${MACOS_KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"

          CURRENT_KEYCHAINS=$(security list-keychains -d user | tr -d '"')
          security list-keychains -d user -s "${KEYCHAIN_PATH}" ${CURRENT_KEYCHAINS}
          security default-keychain -d user -s "${KEYCHAIN_PATH}"

          security find-identity -v -p codesigning "${KEYCHAIN_PATH}"

      - name: Build, Sign, Notarize, and Package
        shell: bash
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
          NOTARY_KEY_ID: ${{ secrets.NOTARY_KEY_ID }}
          NOTARY_ISSUER_ID: ${{ secrets.NOTARY_ISSUER_ID }}
          NOTARY_API_KEY_P8: ${{ secrets.NOTARY_API_KEY_P8 }}
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          DERIVED_DIR="${RUNNER_TEMP}/DerivedData"
          APP_PATH="${DERIVED_DIR}/Build/Products/Release/PortPeek.app"
          DIST_DIR="${GITHUB_WORKSPACE}/dist"
          NOTARY_KEY_PATH="${RUNNER_TEMP}/AuthKey_${NOTARY_KEY_ID}.p8"
          APP_NOTARY_ZIP="${RUNNER_TEMP}/PortPeek-notary.zip"

          mkdir -p "${DIST_DIR}"
          printf '%s' "${NOTARY_API_KEY_P8}" > "${NOTARY_KEY_PATH}"

          xcodebuild \
            -project "${GITHUB_WORKSPACE}/PortPeek.xcodeproj" \
            -scheme PortPeek \
            -configuration Release \
            -derivedDataPath "${DERIVED_DIR}" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            build

          if [[ ! -d "${APP_PATH}" ]]; then
            echo "Build output missing: ${APP_PATH}"
            exit 1
          fi

          echo "==> Signing app bundle"
          codesign \
            --force \
            --deep \
            --options runtime \
            --timestamp \
            --sign "${MACOS_SIGNING_IDENTITY}" \
            "${APP_PATH}"

          codesign --verify --deep --strict --verbose=2 "${APP_PATH}"

          echo "==> Notarizing app bundle"
          ditto -c -k --keepParent "${APP_PATH}" "${APP_NOTARY_ZIP}"
          xcrun notarytool submit "${APP_NOTARY_ZIP}" \
            --key "${NOTARY_KEY_PATH}" \
            --key-id "${NOTARY_KEY_ID}" \
            --issuer "${NOTARY_ISSUER_ID}" \
            --wait
          xcrun stapler staple -v "${APP_PATH}"
          xcrun stapler validate -v "${APP_PATH}"

          echo "==> Creating notarized release zip"
          ditto -c -k --keepParent "${APP_PATH}" "${DIST_DIR}/PortPeek.app.zip"

          STAGING_DIR="${RUNNER_TEMP}/dmg-staging"
          rm -rf "${STAGING_DIR}"
          mkdir -p "${STAGING_DIR}"
          cp -R "${APP_PATH}" "${STAGING_DIR}/"
          ln -s /Applications "${STAGING_DIR}/Applications"

          hdiutil create \
            -volname "PortPeek" \
            -srcfolder "${STAGING_DIR}" \
            -ov \
            -format UDZO \
            "${DIST_DIR}/PortPeek-${VERSION}.dmg"

          echo "==> Notarizing DMG"
          xcrun notarytool submit "${DIST_DIR}/PortPeek-${VERSION}.dmg" \
            --key "${NOTARY_KEY_PATH}" \
            --key-id "${NOTARY_KEY_ID}" \
            --issuer "${NOTARY_ISSUER_ID}" \
            --wait
          xcrun stapler staple -v "${DIST_DIR}/PortPeek-${VERSION}.dmg"
          xcrun stapler validate -v "${DIST_DIR}/PortPeek-${VERSION}.dmg"

          shasum -a 256 "${DIST_DIR}/PortPeek.app.zip" "${DIST_DIR}/PortPeek-${VERSION}.dmg" > "${DIST_DIR}/SHA256SUMS.txt"

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/PortPeek.app.zip
            dist/PortPeek-*.dmg
            dist/SHA256SUMS.txt
